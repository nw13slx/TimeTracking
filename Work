logpath=$HOME/worklog

datestamp=$(date +%Z' '%Y-%m-%d' '%H:%M)
timestamp=$(date +%H:%M)
logdir=$logpath/$(date +%Y/%m)
logfile=$logpath/$(date +%Y/%m/%d)
activities=$logpath/activities
tmp=temp$(date +%s)

activity(){
  #read in activity options
  local aoptions=()
  while IFS= read -r line; do
    aoptions+=("$line")
  done < $activities
  aoptions+=("Quit")
  
  #select one activity
  PS3='activity Please enter your choice: '
  select aopt in "${aoptions[@]}"
  do
    aline="$aopt"
    if [ $aopt = "Quit" ]; then
      break
    fi
    break
  done
  
  #finish the last activities
  if ! grep "**" $logfile|tail -n 1 |grep -q "END" ; then
    line_number=$(grep -n "**" $logfile|tail -n 1|sed 's/:/ /g'|awk '{print $1}')
    sed  "${line_number}s/$/ END $datestamp/" $logfile>$tmp
    mv $tmp $logfile
  fi
  
  #start the current activities
  if [ $aline != "Quit" ]; then
    echo "** $aline START $datestamp" >>$logfile
  fi
}

record(){
  echo "----record----"
  echo "Write the message about the work"
  echo "and type 'save' to save and exit"
  echo "or 'quit' to quit without saving"
  printf "* $datestamp.; ">>$tmp
  echo "----start----"

  #start to input the message
  while IFS= read -r line; do
   if [ "$line" = 'quit' ]; then
     echo "----quit----"
     rm $tmp
     break 
   fi
   if [ "$line" = 'save' ]; then
     echo "----save----"
     cat $tmp >>$logfile
     rm $tmp
     break 
   fi
   printf '%s\n' "$line">>$tmp
  done
}

main(){
  #check whether it is a new year, new month or a new day
  if [ ! -d $logdir ]; then
      mkdir -p $logdir
  fi
  if [ ! -f $logfile ]; then
    echo "$datestamp.; The day starts at $timestamp">>$logfile
  fi

  moptions=("record" "activity" "Quit")
  PS3='main function please enter your choice: '
  select mopt in "${moptions[@]}"
  do
    if [ $mopt = "record" ]; then
      record
      break
    elif [ $mopt = "activity" ]; then
      activity
      break
    else
      break;
    fi
  done
}

main

#!/bin/bash
#note, quotation mark is super important...

logpath=$HOME/worklog

datestamp=$(date +%Z' '%Y-%m-%d' '%H:%M)
timestamp=$(date +%H:%M)
logdir=$logpath/$(date +%Y)
logfile=$logpath/$(date +%Y/%m)
activities=$logpath/activities
tmp=temp$(date +%s)

startaday(){
  sdatestamp=$(date +%Y-%m-%d)
  timestamp=$(date +%H:%M' '%Z)

  last_wake="$(journalctl -b 0|grep "Finishing wakeup"|tail -n 1|awk '{print $1,$2,$3}')"
  last_date=$(echo "$last_wake"|awk '{print $1"-"$2}')
  if [ "$last_date" = "$(date +%b-%d)" ]; then
     timestamp="$(echo $last_wake|awk '{print $3}') $(date +%Z)"
  fi

  if [ ! -f $logfile ]; then
    printf "\\n# $sdatestamp.; The day starts at $timestamp \\n">>$logfile
  else
    if ! grep -q "$sdatestamp" $logfile ; then
       printf "\\n# $sdatestamp.; The day starts at $timestamp \\n">>$logfile
    else
       printf "\\n yeah, in the day, huh \\n"
    fi
  fi
}

activity(){
  #read in activity options
  local aoptions=()
  while IFS= read -r line; do
    aoptions+=("$line")
  done < $activities
  aoptions+=("Quit")
  
  #select one activity
  PS3='activity Please enter your choice: '
  select aopt in "${aoptions[@]}"
  do
    aline="$aopt"
    echo $aline
    if [ "$aopt" = "Quit" ]; then
      break
    fi
    break
  done
  
  #finish the last activities
  if grep "##" $logfile|tail -n 1 |grep -q "END" ; then
    line_number=$(grep -n "START" $logfile|grep "^**"|tail -n 1|sed 's/:/ /g'|awk '{print $1}')
    sed  "${line_number}s/$/ END $datestamp/" $logfile>$tmp
    mv $tmp $logfile
  fi
  
  #start the current activities
  if [ "$aline" != "Quit" ]; then
    printf "\\n**${aline}** START $datestamp\\n" >>$logfile
  fi
}

record(){
  echo "----record----"
  echo "Write the message about the work"
  echo "and type 'save' to save and exit"
  echo "or 'quit' to quit without saving"
  printf "**$datestamp** ">>$tmp
  echo "----start----"

  #start to input the message
  while IFS= read -r line; do
   if [ "$line" = 'quit' ]; then
     echo "----quit----"
     rm $tmp
     break 
   fi
   if [ "$line" = 'save' ]; then
     echo "----save----"
     cat $tmp >>$logfile
     rm $tmp
     break 
   fi
   printf '%s\n\n' "$line">>$tmp
  done
}

gohome(){
    printf "\\n### $sdatestamp.; The day ends at $timestamp \\n">>$logfile
}

main(){
  #check whether it is a new year, new month or a new day
  startaday

  moptions=("record" "activity" "go home" "Quit")
  PS3='main function please enter your choice: '
  select mopt in "${moptions[@]}"
  do
    if [ "$mopt" = "record" ]; then
      record
      break
    elif [ "$mopt" = "activity" ]; then
      activity
      break
    elif [ "$mopt" = "go home" ]; then
      gohome
      break
    else
      break;
    fi
  done
}

main
